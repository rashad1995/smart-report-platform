# -*- coding: utf-8 -*-
"""Untitled8.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19QYy7P3WO3gSSXdkk6itoEwcq3DW166w
"""

import streamlit as st
import pandas as pd
import plotly.express as px
from groq import Groq
import io, fitz, re
from arabic_reshaper import reshape
from bidi.algorithm import get_display

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¨ØµØ±ÙŠØ© ---
st.set_page_config(page_title="Strategic AI Advisor | Master's Project", layout="wide")

def fix_ar(text):
    try: return get_display(reshape(str(text)))
    except: return text

# Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙØªØ§Ø­ API Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¢Ù…Ù†Ø© (Secrets)
# ÙÙŠ ÙƒÙˆÙ„Ø§Ø¨ ÙƒØ§Ù† Ù…ÙƒØªÙˆØ¨Ø§Ù‹ ØµØ±Ø§Ø­Ø©ØŒ Ù‡Ù†Ø§ Ù†Ø³Ø­Ø¨Ù‡ Ø¨Ø£Ù…Ø§Ù†
API_KEY = st.secrets.get("GROQ_API_KEY", "Ø¶Ø¹_Ù…ÙØªØ§Ø­Ùƒ_Ù‡Ù†Ø§_Ù„Ù„ØªØ¬Ø±Ø¨Ø©_Ø§Ù„Ù…Ø­Ù„ÙŠØ©")
client = Groq(api_key=API_KEY)

# --- ØªØµØ§Ù…ÙŠÙ… CSS Ù…Ø®ØµØµØ© Ù„Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ---
st.markdown("""
    <style>
    .main { background-color: #f4f7f9; }
    .stCard { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    h1, h2 { color: #1e3a8a; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .stButton>button { border-radius: 8px; background-color: #1e3a8a; color: white; height: 3em; width: 100%; }
    </style>
    """, unsafe_allow_html=True)

# --- Ù…Ù†Ø·Ù‚ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Caching Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø³Ø±Ø¹Ø©) ---
@st.cache_data
def analyze_document(file_bytes, file_name):
    ext = file_name.split('.')[-1].lower()
    if ext == 'pdf':
        doc = fitz.open(stream=file_bytes, filetype="pdf")
        text = " ".join([page.get_text() for page in doc])
        return text[:5000] # Ù†Ø£Ø®Ø° Ø¹ÙŠÙ†Ø© ÙƒØ§ÙÙŠØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ‚
    else:
        df = pd.read_csv(io.BytesIO(file_bytes)) if ext == 'csv' else pd.read_excel(io.BytesIO(file_bytes))
        return df.describe().to_string()

# --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Sidebar) ---
with st.sidebar:
    st.image("https://cdn-icons-png.flaticon.com/512/2103/2103633.png", width=100)
    st.title("ğŸ¤– Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ")
    uploaded_file = st.file_uploader("Ø§Ø±ÙØ¹ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©", type=['pdf', 'csv', 'xlsx'])

    st.divider()
    st.subheader("ğŸ› ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„")
    depth = st.select_slider("Ø¹Ù…Ù‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ±", options=["Ù…ÙˆØ¬Ø²", "Ù…ØªÙˆØ³Ø·", "ØªØ­Ù„ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ Ù…ÙˆØ³Ø¹"])
    tone = st.selectbox("Ù†Ø¨Ø±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±", ["Ø±Ø³Ù…ÙŠØ© Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©", "Ø¥Ø¨Ø¯Ø§Ø¹ÙŠØ© Ø§Ø³ØªØ´Ø§Ø±ÙŠØ©"])

    if st.button("ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ"):
        if uploaded_file:
            st.session_state.process = True
        else:
            st.warning("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹")

# --- Ø§Ù„Ø³Ø§Ø­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
if uploaded_file and st.session_state.get('process'):
    file_bytes = uploaded_file.getvalue()
    content = analyze_document(file_bytes, uploaded_file.name)

    st.title("ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©")

    # ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø£Ù„Ø³Ù†Ø© (Tabs)
    tab1, tab2, tab3 = st.tabs(["ğŸ“„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ", "ğŸ“ˆ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ØµØ±ÙŠ", "ğŸ’¬ Ù…Ù†Ø§Ù‚Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬"])

    with tab1:
        with st.spinner('ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªÙˆÙ„ÙŠØ¯ Ø±Ø¤Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...'):
            prompt = f"Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ. Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ø¨Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø§Ø¬Ø³ØªÙŠØ± (Ù†Ø¨Ø±Ø© {tone}) ÙˆØ¨Ø¹Ù…Ù‚ ({depth}). Ø§Ù„Ù„ØºØ©: Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰."
            chat = client.chat.completions.create(
                messages=[{"role": "system", "content": prompt},
                          {"role": "user", "content": f"Ø­Ù„Ù„ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø±Ø¤Ù‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: {content}"}],
                model="llama-3.3-70b-versatile"
            )
            report = chat.choices[0].message.content
            st.markdown(f'<div class="stCard">{report}</div>', unsafe_allow_html=True)
            st.download_button("ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ ÙƒÙ…Ù„Ù", report, file_name="analysis.txt")

    with tab2:
        st.subheader("ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©")
        # Ù…Ø«Ø§Ù„ Ù„Ø±Ø³Ù… ØªÙØ§Ø¹Ù„ÙŠ Plotly ÙŠØ¹ÙƒØ³ Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        col1, col2 = st.columns(2)
        with col1:
            fig1 = px.pie(names=[fix_ar('Ø§Ù„ÙØ±Øµ'), fix_ar('Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª'), fix_ar('Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©')],
                          values=[40, 25, 35], hole=0.4, title=fix_ar("ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø«Ù‚Ù„ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ"))
            st.plotly_chart(fig1, use_container_width=True)
        with col2:
            fig2 = px.bar(x=[1, 2, 3, 4], y=[10, 20, 15, 25], title=fix_ar("ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ"))
            st.plotly_chart(fig2, use_container_width=True)

    with tab3:
        st.subheader("ğŸ’¬ Ø§Ø³Ø£Ù„ Ø§Ù„Ù…Ø­Ù„Ù„")
        query = st.text_input("Ù„Ø¯ÙŠÙƒ Ø§Ø³ØªÙØ³Ø§Ø± Ø­ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŸ")
        if query:
            st.info(f"Ø³ÙŠØªÙ… Ø¯Ù…Ø¬ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù‡Ù†Ø§ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰: {query}")

else:
    # ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠØ©
    st.markdown("""
        <div style='text-align: center; margin-top: 50px;'>
            <h1 style='font-size: 3em;'>Strategic Vision Platform</h1>
            <p style='font-size: 1.5em; color: #666;'>Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¬Ø³ØªÙŠØ±: Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø¹Ù… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
            <p>Ù‚Ù… Ø¨Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</p>
        </div>
    """, unsafe_allow_html=True)